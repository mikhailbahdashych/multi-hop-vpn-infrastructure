#!/bin/bash
# Exit node iptables: WireGuard (wg0) -> Internet (eth0)
set -euo pipefail

# Detect the primary network interface
PRIMARY_IFACE=$(ip route show default | awk '/default/ {print $5}' | head -1)

# Flush existing rules
iptables -F FORWARD
iptables -t nat -F POSTROUTING

# NAT traffic from WireGuard to internet
iptables -t nat -A POSTROUTING -o "$PRIMARY_IFACE" -j MASQUERADE

# Forward between wg0 and internet
iptables -A FORWARD -i wg0 -o "$PRIMARY_IFACE" -j ACCEPT
iptables -A FORWARD -i "$PRIMARY_IFACE" -o wg0 -m state --state RELATED,ESTABLISHED -j ACCEPT
